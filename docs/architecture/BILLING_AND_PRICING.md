## Billing and pricing (MVP) — полуфинал

Этот документ фиксирует правила биллинга, ценообразования и списания кредитов.

### 1) Единица биллинга

**Комбинированная формула с ресурсной моделью**:

```
cost_component = base_cost + (compute_time × compute_rate) + (gpu_time × gpu_rate) + markup
```

**Параметры для каждого компонента** (хранятся в таблице `component_pricing` в БД):
- `base_cost`: фиксированная базовая стоимость (например, 0.1 единиц)
- `compute_time_per_frame`: среднее время обработки 1 кадра (CPU, секунды)
- `gpu_time_per_frame`: среднее время на GPU (если требуется)
- `scaling_factor_resolution`: коэффициент масштабирования по разрешению (HD=1.0, 4K=2.5)
- `scaling_factor_duration`: коэффициент по длительности (линейный или логарифмический)
- `markup_percent`: наценка (например, 20%)

**Пример расчёта**:
- Tempo extractor (CPU-only, быстрый): `0.1 + (0.001 × frames × 0.01) + 0.2 = ~0.5 единиц`
- Face emotion (GPU, тяжёлый): `0.1 + (0.05 × frames × 0.5) + (0.1 × frames × 2.0) + 0.3 = ~15 единиц`

**Калибровка**: после каждого run записываем реальное время/ресурсы в `manifest.json` → используем для улучшения модели ценообразования.

### 2) Когда списываем кредиты

**Частичное списание (best practice)**:
- **Резервирование**: при создании run резервируем максимальную сумму (по оценке)
- **Списание**: после завершения списываем только за успешные компоненты
- **Возврат**: разница возвращается на баланс пользователя
- **Partial failures**: если упал non-required компонент → списываем только за успешные
- **Полный failure**: если упал required компонент → ничего не списываем (или минимальная плата за попытку, например 0.1 единиц)
- **Аудит**: все транзакции в `billing_ledger` с привязкой к `run_id` и `component_name`

### 3) Ценообразование (MVP)

**Структура прайс-листа** (таблица `component_pricing` в БД):

| component_name | base_cost | cpu_cost_per_sec | gpu_cost_per_sec | resolution_factor | duration_factor |
|----------------|-----------|------------------|------------------|-------------------|-----------------|
| tempo_extractor | 0.1 | 0.001 | 0 | 1.0 | 0.5 |
| face_emotion | 0.5 | 0.01 | 0.1 | 1.5 | 1.0 |

**Категории компонентов**:
- **Tier-0 (required для prediction)**: фиксированная базовая стоимость (например, 50 единиц за весь набор)
- **Tier-1 (опциональные)**: индивидуальная стоимость каждого

**Формула для оценки**:
```
estimate = sum(component.base_cost × resolution_factor × duration_factor) × (1 + markup)
```

**Калибровка**: после 100-1000 runs собираем реальные метрики и обновляем прайс-лист.

**Стартовая точка**: 1 рубль = 1 единица (нужно учесть реальные затраты на инфраструктуру для калибровки).

### 4) Оценка стоимости до запуска

**Backend-расчёт** (правильный выбор):
- Backend имеет таблицу `component_pricing` в БД
- При создании run backend:
  1. Читает `profile_config` (какие компоненты включены)
  2. Получает параметры видео (разрешение, длительность) от пользователя или из мета
  3. Рассчитывает стоимость по формуле из раздела 1
  4. Показывает оценку пользователю до подтверждения

**Преимущества**:
- Быстро (не нужно ждать DataProcessor)
- Можно кэшировать расчёты для популярных профилей
- Backend контролирует ценообразование (можно менять без деплоя DataProcessor)

**Валидация**: после завершения run можно сравнить оценку с реальной стоимостью для улучшения модели.

