## Product contract (MVP → v1) — полуфинал

Этот документ фиксирует продуктовые решения, которые влияют на архитектуру, контракты данных и исполнение пайплайна.

### 1) Платформы

- **v1**: поддерживаем только **YouTube**.
- `platform_id="youtube"` фиксируем как каноничное значение до расширения на другие платформы.

### 2) Вход продукта (как пользователь инициирует анализ)

- **Вариант A (URL)**: пользователь вводит URL YouTube.
  - Система скачивает видео и подтягивает мета-информацию.
- **Вариант B (Upload)**: пользователь загружает файл видео.
  - Пользователь вручную вводит мета-информацию (минимум: title/description/tags/language/category, если применимо).

**Правило**: вход должен приводиться к каноничному `video_id` (YouTube `video_id` или внутренний ID для upload), который далее используется во всех артефактах.

### 3) Профили анализа (configs) и стоимость

MVP требует режимов “быстро/дёшево” vs “полный/дорого”, но реализуется через **заранее подготовленные профили анализа** (configs):
- Пользователь выбирает профиль (или созданный им кастомный профиль).
- UI до запуска показывает **оценку стоимости и времени**, которые зависят от выбранных фич/модулей.

**Полуфинальное правило**:
- Если в профиле выбран **прогноз** (views/likes), то набор **обязательных** компонентов должен включать training schema (Tier‑0).
- Дополнительные “аналитические” компоненты могут включаться профилем отдельно.

### 4) LLM как presentation layer (MVP)

- LLM генерирует **только текст** (не JSON, не числа как source-of-truth).
- Цель текста: разбор результата + персональные рекомендации.
- Дефолтная длина ответа: **~50–60 предложений** (позже можно добавить настройку длины/тона в аккаунте).

**Воспроизводимость**: версия промпта/модели должна фиксироваться в `manifest.json` (см. `LLM_RENDERING.md`).

### 5) Валидация входных данных

**Валидация на входе (Round 3)**:
- Backend проверяет параметры видео ДО создания run (не списываем кредиты при ошибке валидации)

**Ограничения**:
- **Длительность**: минимум 5 секунд, максимум 20 минут
  - Если < 5 секунд → ошибка: "Видео слишком короткое (минимум 5 секунд)"
  - Если > 20 минут → ошибка: "Видео слишком длинное (максимум 20 минут). Пожалуйста, обрежьте видео или выберите другой файл."
- **Разрешение**: максимум 1080p (4K автоматически downscale до 1080p в Segmenter)
- **Формат**: поддерживаемые форматы видео (MP4, AVI, MOV и т.д.) — конвертация в MP4 в Segmenter при необходимости

**Обработка некорректных данных**:
- Повреждённые файлы: автоматическое исправление через ffmpeg (см. `ERROR_HANDLING_AND_EDGE_CASES.md`)
- Видео без звука: AudioProcessor компоненты получают `empty_reason="audio_missing_or_extract_failed"`, run продолжается (если audio не required)
- Видео без кадров: отказ с ошибкой `video_too_short`

### 6) Video download и preprocessing

**YouTube download (Round 3)**:
- Используем `yt-dlp` для скачивания
- Формат: пользователь выбирает с подсказками о скорости и качестве (для MVP можно начать с дефолта: `bestvideo[height<=1080]+bestaudio/best[height<=1080]`)
- Timeout: динамический, зависит от разрешения и длительности (формула: `max(60, video_duration_sec × 0.1 + 120)`)
- Retry: 3 попытки с backoff `[5s, 15s, 30s]` при network errors

**Preprocessing в Segmenter**:
- Конвертация формата: если входной файл не MP4 → конвертируем через ffmpeg (без перекодирования, если кодеки поддерживаются)
- Downscale до 1080p: если разрешение > 1080p → `ffmpeg -i input -vf "scale=-2:1080:flags=lanczos" -c:a copy output.mp4`
  - `lanczos`: высококачественный алгоритм масштабирования (практически без потерь)
- Без потери качества: используем `-crf 18` или `-c:v copy` (если возможно)
- Логирование: записываем все операции preprocessing в `manifest.json`

**Временное хранилище**:
- Локальный диск worker'а (`/tmp/trendflow/{run_id}/video.mp4`)
- Удаление после Segmenter (или через 1 час TTL)
- Для очень больших видео (> 5GB) можно использовать MinIO для экономии места на диске worker'а


