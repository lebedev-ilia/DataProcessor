# Описание фичей модуля optical_flow

## Общее описание

Модуль optical_flow использует модель RAFT (Recurrent All-Pairs Field Transforms) из torchvision для вычисления оптического потока между последовательными кадрами видео. Модуль предоставляет комплексный анализ движения, включая покадровые статистики, пространственный анализ, временной анализ, анализ движения камеры и продвинутые фичи.

### Что обновилось
- Покадровый вектор для трансформера сжат до ~12 численных признаков: `magnitude_mean_px_sec_norm`, `magnitude_std_px_sec_norm`, `magnitude_p95_px_sec_norm`, `dir_sin_mean`, `dir_cos_mean`, `dir_dispersion`, `dx_mean_norm`, `dy_mean_norm`, `moving_pixels_1.0` (px/sec), `moving_pixels_rel`, `flow_confidence_mean_norm`, `occlusion_fraction`, `fb_error_mean_norm`, `flow_consistency`.
- Углы: sin/cos + circular dispersion, энтропия на ln с Laplace и 36 бинов.
- Motion thresholds в px/sec (учёт fps и frame_skip) + адаптивный порог median+K*MAD.
- Качество потока: forward-backward error (`fb_error_mean`, `fb_error_fraction`), `flow_confidence_mean = 1/(1+fb_error)`, `occlusion_fraction`, `valid_ratio`.
- MEI/MHI затухание зависит от fps (`decay = exp(-dt/tau)`).
- Пространственный анализ multi-scale 1x1/4x4/8x8 с числовой `direction_histogram`, ROI возвращает `direction_hist_summed`.
- Убраны строковые категории (`motion_intensity`, `dominant_direction`, `activity_level`, `direction_category`) из результатов.

## Используемые модели

Модуль использует RAFT (Recurrent All-Pairs Field Transforms) из torchvision:
- **RAFT Small** — быстрая модель для общего использования
- **RAFT Large** — более точная модель для высококачественного анализа

## Структура выходных данных

Результаты модуля организованы в следующую структуру:
- `analysis_info` — информация о версии и времени анализа
- `processing_info` — информация о процессе обработки
- `statistics` — статистические данные (покадровые, пространственные, временные)
- `camera_motion` — анализ движения камеры (опционально)
- `advanced_features` — продвинутые фичи (опционально)

---

## 1. analysis_info

Метаинформация о проведенном анализе.

### 1.1. version

Версия модуля анализа (например, "1.0.0").

### 1.2. timestamp

Временная метка проведения анализа в формате ISO 8601.

---

## 2. processing_info

Информация о процессе обработки видео.

### 2.1. total_frames_analyzed

Общее количество проанализированных кадров.

### 2.2. frames_with_spatial_analysis

Количество кадров, для которых выполнен пространственный анализ.

### 2.3. analysis_duration_seconds

Длительность анализа в секундах.

---

## 3. statistics

Основные статистические данные анализа оптического потока.

### 3.1. frame_statistics

Массив покадровых статистик для каждого кадра.

#### 3.1.1. - 3.1.8. Статистики величины движения (magnitude)

**magnitude_mean** — среднее значение величины движения (скорости) по всем пикселям кадра.

**magnitude_std** — стандартное отклонение величины движения.

**magnitude_max** — максимальное значение величины движения.

**magnitude_min** — минимальное значение величины движения.

**magnitude_median** — медианное значение величины движения (50-й перцентиль).

**magnitude_iqr** — межквартильный размах (разница между 75-м и 25-м перцентилями).

**magnitude_p90** — 90-й перцентиль величины движения.

**magnitude_p95** — 95-й перцентиль величины движения.

**Алгоритм**: 
```python
magnitude = np.sqrt(dx**2 + dy**2)
flat_mag = magnitude.flatten()
percentiles = np.percentile(flat_mag, [25, 50, 75, 90, 95])
```

#### 3.1.9. - 3.1.11. Статистики направления движения (direction)

**direction_mean** — среднее направление движения (в радианах, циклическое среднее).

**direction_std** — стандартное отклонение направления (циклическое стандартное отклонение).

**direction_entropy** — энтропия распределения направлений, показывающая разнообразие направлений движения.

**Алгоритм**:
- Направление вычисляется как `direction = np.arctan2(dy, dx)`
- Для циклических данных используется специальная формула среднего и стандартного отклонения
- Энтропия вычисляется через гистограмму направлений (по умолчанию 36 бинов)

#### 3.1.12. - 3.1.17. Статистики компонентов движения (dx, dy)

**dx_mean** — среднее значение горизонтальной компоненты движения.

**dy_mean** — среднее значение вертикальной компоненты движения.

**dx_std** — стандартное отклонение горизонтальной компоненты.

**dy_std** — стандартное отклонение вертикальной компоненты.

**dx_abs_mean** — среднее абсолютное значение горизонтальной компоненты.

**dy_abs_mean** — среднее абсолютное значение вертикальной компоненты.

#### 3.1.18. - 3.1.20. Движущиеся пиксели (moving_pixels)

**moving_pixels_0.5** — доля пикселей с величиной движения > 0.5 пикселя.

**moving_pixels_1.0** — доля пикселей с величиной движения > 1.0 пикселя.

**moving_pixels_2.0** — доля пикселей с величиной движения > 2.0 пикселя.

**Алгоритм**: Для каждого порога вычисляется доля пикселей, превышающих порог.

#### 3.1.21. - 3.1.22. Форма распределения величины движения

**magnitude_skew** — асимметрия распределения величины движения (skewness).

**magnitude_kurtosis** — эксцесс распределения величины движения (kurtosis).

**Алгоритм**: Используется `scipy.stats.skew()` и `scipy.stats.kurtosis()`.

#### 3.1.23. - 3.1.25. Пространственные характеристики потока

**spatial_gradient** — средний градиент величины движения в пространстве, показывающий резкость изменений движения.

**flow_consistency** — консистентность потока (обратная величина дивергенции), показывающая согласованность векторов движения.

**flow_divergence_mean** — средняя дивергенция потока, показывающая расширение/сжатие движения.

**Алгоритм**:
- Градиент вычисляется через `np.gradient(magnitude)`
- Дивергенция: `div = np.gradient(dx, axis=1) + np.gradient(dy, axis=0)`
- Консистентность: `1.0 / (1.0 + np.mean(np.abs(div)))`

#### 3.1.26. - 3.1.27. Категориальные характеристики

**motion_intensity** — категориальная оценка интенсивности движения:
- `very_low` — средняя величина < 0.5
- `low` — средняя величина < 1.0
- `medium` — средняя величина < 2.0
- `high` — средняя величина < 5.0
- `very_high` — средняя величина >= 5.0

**dominant_direction** — доминирующее направление движения:
- `right`, `up_right`, `up`, `up_left`, `left`, `down_left`, `down`, `down_right`
- Определяется через гистограмму направлений (8 направлений по 45 градусов)

#### 3.1.28. - 3.1.29. Метаданные кадра

**frame_shape** — размеры кадра в формате "(height, width)".

**pixel_count** — общее количество пикселей в кадре.

#### 3.1.30. - 3.1.43. Статистики движения камеры (camera_motion)

Эти фичи доступны только при включенном `enable_camera_motion`.

**camera_motion_mean** — среднее значение движения камеры (величина движения фона).

**camera_motion_std** — стандартное отклонение движения камеры.

**camera_motion_max** — максимальное значение движения камеры.

**camera_motion_energy** — энергия движения камеры (сумма квадратов величин движения).

**camera_motion_entropy** — энтропия движения камеры, показывающая разнообразие направлений.

**camera_shake_var** — дисперсия тряски камеры (вариативность движения фона).

**camera_shake_mean** — среднее значение тряски камеры.

**camera_shake_max** — максимальное значение тряски камеры.

**camera_affine_scale** — масштаб аффинного преобразования камеры (zoom).

**camera_affine_rotation** — угол поворота камеры (в радианах).

**camera_affine_tx** — горизонтальное смещение камеры.

**camera_affine_ty** — вертикальное смещение камеры.

**camera_background_ratio** — доля пикселей, классифицированных как фон (по порогу величины движения).

**camera_rotation_speed** — скорость вращения камеры (изменение угла поворота между кадрами).

**Алгоритм**:
- Фон определяется через порог величины движения (`mag_bg_thresh`, по умолчанию 0.5)
- Аффинное преобразование оценивается через RANSAC на фоновых пикселях
- Тряска вычисляется как вариативность движения фона

---

### 3.2. spatial_analysis

Пространственный анализ движения по сетке регионов.

#### 3.2.1. regional_stats

Массив статистик для каждого региона сетки.

**Параметры**:
- `grid_size` — размер сетки (по умолчанию (4, 4), т.е. 4x4 = 16 регионов)

**Для каждого региона вычисляются**:

**region_id** — идентификатор региона в формате "R{row}_{col}".

**grid_position** — позиция в сетке в формате "{row},{col}".

**pixel_coords** — координаты пикселей региона в формате "{y_start}:{y_end},{x_start}:{x_end}".

**region_size** — количество пикселей в регионе.

**region_magnitude_mean** — среднее значение величины движения в регионе.

**region_magnitude_std** — стандартное отклонение величины движения в регионе.

**region_dx_mean** — среднее значение горизонтальной компоненты в регионе.

**region_dy_mean** — среднее значение вертикальной компоненты в регионе.

**relative_activity** — относительная активность региона (отношение средней величины региона к глобальной средней).

**motion_dominance** — доля пикселей региона с величиной движения выше глобальной средней.

**region_gradient** — градиент величины движения в регионе.

**flow_divergence** — дивергенция потока в регионе.

**activity_level** — категориальная оценка активности региона:
- `very_low` — relative_activity < 0.3
- `low` — relative_activity < 0.7
- `average` — relative_activity < 1.3
- `high` — relative_activity < 2.0
- `very_high` — relative_activity >= 2.0

**direction_category** — категория направления движения в регионе:
- `horizontal_right`, `horizontal_left`
- `vertical_up`, `vertical_down`
- `diagonal_up_right`, `diagonal_up_left`, `diagonal_down_right`, `diagonal_down_left`

#### 3.2.2. roi_analysis

Анализ регионов интереса (ROI) — топ регионов по активности.

**top_regions** — список идентификаторов топ-N регионов по средней величине движения (по умолчанию N=3).

**activity_concentration** — концентрация активности (сумма активности топ регионов / общая активность).

**spatial_distribution** — пространственное распределение активности:
- `single_region` — активность сосредоточена в одном регионе
- `concentrated` — активность сосредоточена в близких регионах
- `scattered` — активность разбросана по нескольким регионам
- `distributed` — активность равномерно распределена

**dominant_directions** — словарь доминирующих направлений в топ регионах (ключи — категории направлений, значения — количество регионов).

---

### 3.3. temporal_analysis

Временной анализ движения по всему видео.

#### 3.3.1. trends

Анализ трендов для метрик: `magnitude`, `moving_pixels`, `direction_std`, `spatial_gradient`.

Для каждой метрики вычисляются:

**slope** — наклон тренда (коэффициент линейной регрессии).

**trend_type** — тип тренда:
- `stable` — |slope| < 0.001
- `increasing` — slope > 0
- `decreasing` — slope < 0

**mean** — среднее значение метрики.

**std** — стандартное отклонение метрики.

**range** — размах значений (max - min).

**has_trend** — наличие значимого тренда (|slope| > 0.001).

**Алгоритм**: Используется полиномиальная регрессия (`np.polyfit`) и сглаживание Savitzky-Golay.

#### 3.3.2. periodicity

Анализ периодичности для метрик: `magnitude`, `moving_pixels`, `direction_std`, `spatial_gradient`.

Для каждой метрики:

**has_periodicity** — наличие периодичности (bool).

**reason** — причина отсутствия периодичности (если `has_periodicity=False`):
- `insufficient_data` — недостаточно данных (< 20 кадров)
- `analysis_error` — ошибка анализа

Если периодичность обнаружена, дополнительно:

**dominant_frequency_hz** — доминирующая частота в Гц.

**dominant_period_seconds** — доминирующий период в секундах.

**significance** — значимость периодичности (отношение мощности доминирующей частоты к средней).

**Алгоритм**: Используется FFT (Fast Fourier Transform) для анализа частотного спектра.

#### 3.3.3. transitions

Анализ переходов (резких изменений) для метрик: `magnitude`, `moving_pixels`, `direction_std`, `spatial_gradient`.

Для каждой метрики:

**transition_count** — количество обнаруженных переходов.

**transition_points** — список точек переходов с информацией:
- `frame_index` — индекс кадра перехода
- `z_score` — Z-score аномалии
- `value_change` — изменение значения относительно среднего

**max_z_score** — максимальный Z-score среди всех переходов.

**Алгоритм**: Используется скользящее окно для вычисления локального среднего и стандартного отклонения, затем Z-score для детекции аномалий (порог > 2.0).

#### 3.3.4. segments

Временная сегментация видео на сегменты с различной активностью движения.

**segments** — массив сегментов, каждый содержит:
- `start_frame` — начальный кадр сегмента
- `end_frame` — конечный кадр сегмента
- `length_frames` — длина сегмента в кадрах
- `mean_magnitude` — средняя величина движения в сегменте
- `std_magnitude` — стандартное отклонение величины движения
- `cluster_label` — метка кластера (для k-means)

**boundary_frames** — список граничных кадров между сегментами.

**method** — метод сегментации:
- `kmeans` — K-means кластеризация по величине движения
- `uniform` — равномерная сегментация (fallback)

#### 3.3.5. summary

Сводка временного анализа.

**total_duration_seconds** — общая длительность видео в секундах.

**avg_magnitude** — средняя величина движения по всему видео.

**magnitude_variability** — вариативность величины движения (коэффициент вариации).

**activity_peaks_count** — количество пиков активности (локальных максимумов).

**stability_score** — оценка стабильности движения (0-1, выше = стабильнее).

**Алгоритм**: Стабильность вычисляется как среднее обратных коэффициентов вариации для всех метрик.

---

### 3.4. summary_metrics

Сводные метрики по всему видео.

**overall_magnitude_mean** — средняя величина движения по всем кадрам.

**overall_magnitude_std** — стандартное отклонение величины движения по всем кадрам.

**activity_variability** — вариативность активности (стандартное отклонение доли движущихся пикселей).

**dominant_motion_intensity** — наиболее часто встречающаяся категория интенсивности движения.

**dominant_direction** — наиболее часто встречающееся направление движения.

**temporal_stability** — стабильность движения во времени (из `temporal_analysis.summary.stability_score`).

**peak_activity_frames** — количество кадров с пиковой активностью.

**dominant_trend** — доминирующий тренд движения (`increasing`, `decreasing`, `stable`).

**has_periodicity** — наличие периодичности в движении (если хотя бы одна метрика имеет периодичность).

**transition_count** — общее количество переходов по всем метрикам.

---

### 3.5. camera_motion

Анализ движения камеры (доступен только при `enable_camera_motion=True`).

#### 3.5.1. summary

Агрегированные статистики движения камеры по всему видео.

**motion_mean_mean/std/max/min** — статистики среднего движения камеры по кадрам.

**motion_std_mean/std/max/min** — статистики стандартного отклонения движения камеры по кадрам.

**motion_energy_sum** — суммарная энергия движения камеры.

**motion_entropy_mean** — средняя энтропия движения камеры.

**shake_mean/std/max** — статистики тряски камеры.

**zoom_in_count** — количество зумов внутрь.

**zoom_out_count** — количество зумов наружу.

**zoom_speed_mean** — средняя скорость зума.

**rotation_speed_mean/std** — статистики скорости вращения камеры.

**pan_ratio** — доля кадров с панорамированием (горизонтальное вращение).

**truck_ratio** — доля кадров с движением влево/вправо (truck).

**pedestal_ratio** — доля кадров с движением вверх/вниз (pedestal).

**static_ratio** — доля статичных кадров (без значимого движения камеры).

**chaos_index** — индекс хаоса движения камеры (энтропия направлений).

**style_handheld** — оценка стиля "handheld" (0-1, выше = больше тряски).

**style_tripod** — оценка стиля "tripod" (0-1, выше = стабильнее).

**style_cinematic** — оценка стиля "cinematic" (0-1, выше = плавнее).

**style_drone** — оценка стиля "drone" (0-1, выше = больше хаоса).

**style_action_cam** — оценка стиля "action cam" (0-1, выше = больше движения и тряски).

**n_frames** — количество проанализированных кадров.

#### 3.5.2. per_frame

Массив покадровых статистик движения камеры (те же поля, что и в `frame_statistics.camera_*`).

---

### 3.6. advanced_features

Продвинутые фичи анализа движения (доступны только при `enable_advanced_features=True`).

#### 3.6.1. motion_energy_image

Motion Energy Image (MEI) и Motion History Image (MHI) — компактное представление движения за временное окно.

**features**:

**mei_total_energy** — суммарная энергия движения (сумма всех пикселей MEI).

**mei_coverage_ratio** — доля пикселей с движением (среднее значение MEI).

**mei_max_energy** — максимальная энергия движения.

**mei_std** — стандартное отклонение энергии движения.

**mhi_contrast** — контраст Motion History Image (разница между max и min).

**mhi_entropy** — энтропия Motion History Image.

**mhi_mean** — среднее значение Motion History Image.

**mhi_max** — максимальное значение Motion History Image.

**motion_persistence** — доля пикселей с устойчивым движением (MHI > 0.5).

**mei_shape** — размеры MEI изображения `[height, width]`.

**Алгоритм**:
- MEI — бинарное изображение, где 1 = было движение (порог по 50-му перцентилю)
- MHI — накопление движения с затуханием (decay_factor = 0.9)

#### 3.6.2. foreground_background_motion

Разделение движения на передний и задний план.

**summary**:

**foreground_motion_energy_mean** — средняя энергия движения переднего плана.

**background_motion_energy_mean** — средняя энергия движения заднего плана.

**ratio_foreground_background_mean** — среднее соотношение энергий переднего и заднего плана.

**foreground_coverage_mean** — средняя доля переднего плана.

**per_frame_count** — количество проанализированных кадров.

**Методы разделения**:
- `magnitude_threshold` — по порогу величины движения (по умолчанию)
- `spatial_clustering` — кластеризация по величине и позиции
- `segmentation` — с использованием маски сегментации

#### 3.6.3. motion_clusters

Кластеризация векторов движения для обнаружения различных паттернов движения.

**summary**:

**num_clusters_mean** — среднее количество кластеров движения.

**largest_cluster_coverage_mean** — средняя доля покрытия крупнейшим кластером.

**cluster_diversity_mean** — среднее разнообразие кластеров (отношение количества кластеров к заданному числу).

**per_frame_count** — количество проанализированных кадров.

**Алгоритм**: K-means кластеризация по направлению и скорости движения (по умолчанию 5 кластеров).

#### 3.6.4. smoothness_jerkiness

Метрики плавности и резкости движения.

**smoothness_index** — индекс плавности (0-1, выше = плавнее).

**jerkiness_index** — индекс резкости (ниже = плавнее).

**flow_temporal_entropy** — энтропия временных изменений потока.

**movement_stability** — стабильность движения (0-1, выше = стабильнее).

**mean_acceleration** — среднее ускорение движения.

**std_acceleration** — стандартное отклонение ускорения.

**max_acceleration** — максимальное ускорение.

**mean_jerk** — средний рывок (вторая производная движения).

**max_jerk** — максимальный рывок.

**Алгоритм**:
- Ускорение вычисляется как изменение величины движения между кадрами
- Рывок (jerk) — изменение ускорения
- Плавность = `1.0 / (1.0 + mean_acceleration)`
- Стабильность = `1.0 / (1.0 + coefficient_of_variation)`

---

## Технические детали

### Конфигурация

Модуль поддерживает обширную конфигурацию через `FlowPipelineConfig` и `FlowStatisticsConfig`:

**FlowPipelineConfig**:
- `model_type` — тип модели (`small` или `large`)
- `max_dimension` — максимальный размер стороны кадра для обработки
- `save_overlay` — сохранять ли визуализации движения
- `save_flow_tensors` — сохранять ли тензоры потока

**FlowStatisticsConfig**:
- `grid_size` — размер сетки для пространственного анализа
- `motion_thresholds` — пороги для moving_pixels
- `direction_bins` — количество бинов для анализа направлений
- `spatial_sample_rate` — частота выборки для пространственного анализа
- `top_regions_count` — количество топ регионов для ROI анализа
- `enable_camera_motion` — включить анализ движения камеры
- `enable_advanced_features` — включить продвинутые фичи
- `enable_mei`, `enable_fg_bg`, `enable_clusters`, `enable_smoothness` — включение отдельных продвинутых фич

### Формат данных

Оптический поток представляется как тензор формы `[2, H, W]`, где:
- Первый канал — горизонтальная компонента движения (dx)
- Второй канал — вертикальная компонента движения (dy)
- Значения — смещение в пикселях между кадрами

### Производительность

- RAFT Small: быстрее, подходит для общего использования
- RAFT Large: точнее, но медленнее
- Рекомендуется использовать GPU для ускорения обработки
- Параметр `max_dimension` позволяет балансировать между точностью и скоростью

