# Описание фичей модуля behavioral

## 1. frame_results

Результаты анализа поведения для каждого кадра видео.

### 1.1. hand_gestures

Список распознанных жестов рук в текущем кадре. Модуль распознает следующие типы жестов:

- **pointing** — указание рукой (вытянутый указательный палец, остальные согнуты)
- **open_palm** — раскрытые ладони (все пальцы вытянуты)
- **hands_on_hips** — руки в боки (запястья находятся рядом с талией)
- **self_touch** — self-touch жесты (поглаживание, почёсывание — индикатор стресса)
- **fist** — кулак (все пальцы согнуты)
- **thumbs_up** — большой палец вверх
- **thumbs_down** — большой палец вниз
- **victory** — победа (V-жест: указательный и средний пальцы вытянуты)
- **ok** — OK знак (большой и указательный пальцы образуют круг)
- **rock** — рок (рога: указательный и мизинец вытянуты)
- **call_me** — позвони мне (мизинец и большой палец соединены)
- **love** — любовь (сердце: указательный и средний пальцы вытянуты в форме сердца)
- **unknown** — неузнанный жест

#### Алгоритм:

1. **Определение состояния пальцев**: Для каждого пальца проверяется позиция кончика относительно сустава (PIP). Для большого пальца проверка выполняется по оси X, для остальных — по оси Y.

2. **Классификация жестов**: Последовательно проверяются условия для каждого типа жеста. Первый подходящий жест возвращается как результат.

3. **Использование MediaPipe Hands**: Модуль использует MediaPipe Hands для детекции ключевых точек рук (21 точка на руку).

### 1.2. num_hands

Количество обнаруженных рук в кадре (0, 1 или 2).

### 1.3. body_language

Анализ языка тела и позы человека.

#### 1.3.1. posture

Определяет позу тела: `"standing"` (стоя) или `"sitting"` (сидя).

**Алгоритм**: Вычисляется среднее расстояние между плечами и бедрами. Если расстояние больше 20% высоты кадра — поза считается стоячей, иначе — сидячей.

#### 1.3.2. open_posture

Булево значение, указывающее на открытую позу (руки широко расставлены).

**Алгоритм**: Сравнивается расстояние между запястьями с шириной плеч. Если расстояние между запястьями > 1.2 × ширина плеч, поза считается открытой.

#### 1.3.3. closed_posture

Булево значение, указывающее на закрытую позу (руки скрещены или близко к телу).

**Алгоритм**: Если расстояние между запястьями < 0.8 × ширина плеч, поза считается закрытой.

#### 1.3.4. power_pose

Булево значение, указывающее на доминантную позу (руки на бедрах, широко расставлены).

**Алгоритм**: Проверяется, что запястья находятся на уровне бедер (вертикальное расстояние < 10% высоты кадра) и широко расставлены (горизонтальное расстояние > 1.5 × ширина плеч).

#### 1.3.5. rigidity

Булево значение, указывающее на напряженность позы (прямые плечи).

**Алгоритм**: Вычисляется угол наклона линии плеч. Если угол < 5 градусов, поза считается напряженной.

#### 1.3.6. relaxed

Булево значение, указывающее на расслабленность позы.

**Алгоритм**: Расслабленность = не напряженность И не закрытая поза.

#### 1.3.7. forward_lean

Булево значение, указывающее на наклон тела вперед.

**Алгоритм**: Сравнивается позиция носа с центром плеч. Если нос смещен вперед более чем на 2% ширины кадра, фиксируется наклон вперед.

#### 1.3.8. backward_lean

Булево значение, указывающее на наклон тела назад.

**Алгоритм**: Аналогично forward_lean, но для смещения назад.

#### 1.3.9. balance_offset

Смещение центра масс тела относительно центра кадра. Значение от -1 до 1, где 0 — центр кадра, отрицательные значения — смещение влево, положительные — вправо.

**Алгоритм**: Вычисляется центр масс как среднее между центром плеч и центром бедер, затем нормализуется относительно ширины кадра.

### 1.4. speech_behavior

Анализ движения губ и активности речи.

#### 1.4.1. mouth_width

Ширина рта в пикселях, вычисляемая как разница между максимальной и минимальной X-координатами точек верхней губы.

#### 1.4.2. mouth_height

Высота рта в пикселях, вычисляемая как расстояние между центрами верхней и нижней губ.

#### 1.4.3. mouth_area

Приблизительная площадь рта в пикселях², вычисляемая как произведение ширины и высоты.

#### 1.4.4. speech_activity

Вероятность активности речи (0.0-1.0), вычисляемая на основе изменения площади рта во времени.

**Алгоритм**: 
- Сохраняется история параметров рта за последние 10 кадров
- Вычисляется среднее изменение площади рта между последовательными кадрами
- Нормализуется относительно размера кадра: `min(1.0, avg_change / (width * 0.01))`

#### 1.4.5. mouth_open_ratio

Соотношение открытия рта (высота / ширина), показывающее форму открытия рта.

### 1.5. engagement

Индекс вовлеченности человека (0.0-1.0), вычисляемый на основе нескольких факторов.

#### 1.5.1. engagement_score

Общий индекс вовлеченности, среднее значение всех факторов вовлеченности.

**Факторы вовлеченности**:
- **eye_contact** (0.0-1.0): Зрительный контакт с камерой, вычисляется на основе позиции носа относительно центра кадра
- **head_movement** (0.0-1.0): Активность движений головы, основанная на вариативности позиции головы во времени
- **gesture_activity** (0.0-1.0): Активность жестов, пропорциональная количеству обнаруженных рук
- **open_posture** (0.0-1.0): Открытая поза способствует вовлеченности

#### 1.5.2. engagement_variation

Вариативность индекса вовлеченности во времени, вычисляемая как стандартное отклонение за последние 30 кадров.

#### 1.5.3. engagement_peaks

Количество пиков вовлеченности (локальных максимумов) за последние 30 кадров.

#### 1.5.4. engagement_consistency

Консистентность вовлеченности (1.0 - вариативность), показывающая стабильность уровня вовлеченности.

#### 1.5.5. factors

Детализация факторов вовлеченности с их индивидуальными оценками.

### 1.6. confidence

Индекс уверенности и доминантности человека (0.0-1.0).

#### 1.6.1. confidence_score

Общий индекс уверенности, среднее значение всех факторов уверенности.

**Факторы уверенности**:
- **open_posture** (0.0-1.0): Открытая поза (0.3), power pose (1.0), закрытая поза (0.3)
- **head_straight** (0.0-1.0): Прямое положение головы, вычисляется на основе симметрии лица
- **confident_gestures** (0.0-1.0): Наличие уверенных жестов (open_palm, pointing, thumbs_up)
- **shoulder_level** (0.0-1.0): Уровень плеч, показывающий прямую осанку

#### 1.6.2. dominance_score

Индекс доминантности, основанный на индексе уверенности с дополнительным бонусом за power pose (×1.2, максимум 1.0).

#### 1.6.3. confidence_variability

Вариативность индекса уверенности во времени, вычисляемая как стандартное отклонение за последние 30 кадров.

#### 1.6.4. confidence_peak_moments

Количество моментов пиковой уверенности (локальных максимумов) за последние 30 кадров.

#### 1.6.5. factors

Детализация факторов уверенности с их индивидуальными оценками.

### 1.7. stress

Детекция признаков стресса и тревожности.

#### 1.7.1. stress_level

Общий уровень стресса (0.0-1.0), вычисляемый как среднее значение интенсивности всех индикаторов стресса.

#### 1.7.2. anxiety_score

Индекс тревожности (0.0-1.0), вычисляемый как `stress_level × 0.9`.

#### 1.7.3. stress_indicators

Детализация индикаторов стресса с информацией о наличии и интенсивности каждого индикатора.

**Индикаторы стресса**:

1. **frequent_blinking**: Частое моргание
   - **Алгоритм**: Вычисляется EAR (Eye Aspect Ratio) для обоих глаз. Моргание детектируется при EAR < 0.2. Высокая частота моргания (>30% времени) указывает на стресс.

2. **self_touch**: Self-touch жесты (поглаживание, почёсывание)
   - **Алгоритм**: Детектируется через классификацию жестов рук. Если рука находится близко к лицу (wrist.y < 0.3), фиксируется self-touch.

3. **closed_posture**: Закрытая поза
   - **Алгоритм**: См. описание closed_posture в body_language.

4. **rigidity**: Напряженность позы
   - **Алгоритм**: См. описание rigidity в body_language.

5. **fidgeting**: Ёрзание, быстрые мелкие движения
   - **Алгоритм**: Вычисляется вариативность позиции носа за последние 5 кадров. Высокая вариативность (>0.001) указывает на ёрзание.

6. **async_movement**: Несинхронные движения рук
   - **Алгоритм**: Если обнаружены обе руки, вычисляется расстояние между запястьями. Большое расстояние (>0.3) указывает на несинхронность движений.

#### 1.7.4. stress_count

Количество активных индикаторов стресса (индикаторов с `present: true`).

### 1.8. timestamp

Временная метка кадра в секундах, вычисляемая как `frame_index / fps`.

## 2. aggregated

Агрегированные результаты анализа по всему видео.

### 2.1. avg_engagement

Средний индекс вовлеченности по всем кадрам.

### 2.2. avg_confidence

Средний индекс уверенности по всем кадрам.

### 2.3. avg_stress

Средний уровень стресса по всем кадрам.

### 2.4. max_engagement

Максимальный индекс вовлеченности за все видео.

### 2.5. max_confidence

Максимальный индекс уверенности за все видео.

### 2.6. max_stress

Максимальный уровень стресса за все видео.

### 2.7. gesture_statistics

Статистика жестов по всему видео. Словарь, где ключи — типы жестов, значения — количество их появлений.

**Пример**:
```json
{
  "pointing": 45,
  "open_palm": 30,
  "thumbs_up": 12
}
```

### 2.8. posture_statistics

Статистика поз по всему видео. Словарь, где ключи — типы поз (`"standing"`, `"sitting"`), значения — количество кадров с данной позой.

**Пример**:
```json
{
  "standing": 800,
  "sitting": 200
}
```

## Технические детали

### Используемые модели

Модуль использует MediaPipe для анализа позы, рук и лица:

- **MediaPipe Pose**: Детекция позы тела (33 ключевые точки)
- **MediaPipe Hands**: Детекция рук и жестов (21 ключевая точка на руку)
- **MediaPipe Face Mesh**: Детекция лица и губ (468 ключевых точек)

### Параметры конфигурации

Все модели MediaPipe поддерживают настройку через параметры:
- `static_image_mode`: Режим статического изображения или видео
- `model_complexity`: Сложность модели (0-2)
- `min_detection_confidence`: Минимальная уверенность детекции (0.0-1.0)
- `min_tracking_confidence`: Минимальная уверенность трекинга (0.0-1.0)

### Обработка истории

Некоторые метрики требуют истории кадров для вычисления:
- **engagement**: История за 30 кадров
- **confidence**: История за 30 кадров
- **stress**: История морганий за 30 кадров, история движений за 30 кадров
- **speech_behavior**: История параметров рта за 10 кадров

