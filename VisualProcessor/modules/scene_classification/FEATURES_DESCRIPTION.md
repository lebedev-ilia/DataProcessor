# Описание фичей модуля scene_classification

## 1. Базовые фичи сцены

### indices, start_frame, end_frame, length_frames, length_seconds
- **indices**: Список индексов кадров, принадлежащих данной сцене.
- **start_frame / end_frame**: Границы сцены в индексах кадров.
- **length_frames**: Длина сцены в кадрах.
- **length_seconds**: Длина сцены в секундах с учётом реального `fps` из `FrameManager`.

Сцены определяются как последовательные кадры с одинаковым предсказанным лейблом Places365, но отфильтровываются по минимальной длительности **в секундах** (`min_scene_seconds`). Если `min_scene_seconds` не задан, он выводится из порога по кадрам и текущего `fps`.

### mean_score, class_entropy_mean, top1_prob_mean, top1_vs_top2_gap_mean, fraction_high_confidence_frames
- **mean_score**: средняя вероятность top‑1 предсказания сцены по кадрам.
- **class_entropy_mean**: средняя энтропия распределения по 365 классам Places365 (Shannon entropy) по кадрам — мера «неопределённости» модели.
- **top1_prob_mean**: средняя уверенность top‑1 класса по кадрам.
- **top1_vs_top2_gap_mean**: средний разрыв между top‑1 и top‑2 вероятностями; большие значения соответствуют более «чётким» сценам.
- **fraction_high_confidence_frames**: доля кадров в сцене, где top‑1 вероятность > 0.7.

Все эти признаки вычисляются на основе полных распределений вероятностей Places365 и агрегируются как средние по кадрам.

## 2. Indoor/Outdoor классификация

### mean_indoor, mean_outdoor
Средние вероятности того, что сцена является внутренним помещением или внешним пространством.

Вместо строкового keyword‑matching только по одному лейблу используется **онтология top‑K классов**:

- для каждого кадра берутся top‑K (по умолчанию K=5) классов Places365 и их вероятности;
- для каждого top‑K лейбла проверяется наличие в списках `indoor_keywords` / `outdoor_keywords`;
- indoor_score = sum(prob_i * I(label_i ∈ indoor)), outdoor_score = sum(prob_i * I(label_i ∈ outdoor));
- если лейбл попадает в обе группы, вес делится поровну (0.5/0.5);
- при отсутствии информации возвращается распределение по умолчанию (0.5/0.5).

По сцене считается простое среднее этих вероятностей по всем кадрам: **mean_indoor**, **mean_outdoor**.

## 3. Nature/Urban классификация

### mean_nature, mean_urban
Средние вероятности того, что сцена является природной или городской. Аналогично indoor/outdoor, используется **онтология top‑K Places‑лейблов**:

- для каждого кадра: nature_score = sum(prob_i * I(label_i ∈ nature_keywords)),
  urban_score = sum(prob_i * I(label_i ∈ urban_keywords));
- при отсутствии информации возвращается (0.5/0.5).

По сцене берётся среднее по кадрам.

## 5. Aesthetic Score

### mean_aesthetic_score, aesthetic_std, aesthetic_frac_high
Оценка эстетической привлекательности сцены (0.0‑1.0).

- На уровне кадра: **CLIP‑based zero‑shot** (позитивные против негативных промптов) на базе `core_clip` (без локального CLIP и без эвристик).
- На уровне сцены:
  - **mean_aesthetic_score** — среднее по кадрам;
  - **aesthetic_std** — стандартное отклонение по кадрам (стабильность эстетики);
  - **aesthetic_frac_high** — доля кадров с эстетическим скором > 0.8.

## 6. Luxury Score

### mean_luxury_score
Оценка "роскошности" сцены (0.0‑1.0).

- На уровне кадра: либо CLIP‑based zero‑shot (luxury vs cheap), либо аккуратная эвристика (качество изображения + цветовое богатство + слабый вклад ключевых слов в лейбле).
- На уровне сцены: **mean_luxury_score** — среднее по кадрам.

Рекомендуется использовать luxury‑фичи только в комбинации с другими признаками и с дополнительным контролем bias.

## 7. Atmosphere Sentiment

### mean_cozy, mean_scary, mean_epic, mean_neutral, atmosphere_entropy
Вероятности атмосферы сцены (уютная, страшная, эпическая, нейтральная).

- На уровне кадра: **CLIP zero‑shot (4 класса)** на базе `core_clip` (без эвристик).
- На уровне сцены:
  - **mean_cozy / mean_scary / mean_epic / mean_neutral** — средние вероятности по кадрам;
  - **atmosphere_entropy** — энтропия усреднённого распределения `[cozy, scary, epic, neutral]`, показывающая «определённость» атмосферы.

### scene_change_score, label_stability, dominant_places_topk_ids, dominant_places_topk_probs
- **scene_change_score**: мера вариативности сцены, основанная на стандартном отклонении confidence top‑1 по кадрам (чем выше, тем менее стабильна сцена).
- **label_stability**: доля кадров в сцене, у которых top‑1 лейбл совпадает с доминирующим лейблом сцены.
- **dominant_places_topk_ids**: top‑K (до 5) индексы классов Places365, доминирующих в сцене (по суммарному весу вероятностей по кадрам).
- **dominant_places_topk_probs**: соответствующие суммарные веса (агрегированные вероятности) для этих классов.

## Примечания

Все фичи с префиксом "mean_" вычисляются как среднее значение по всем кадрам, принадлежащим одной сцене. Сцены агрегируются из последовательных кадров с одинаковым предсказанным лейблом Places365, после чего:

- длина сцены нормируется по `fps` (`length_seconds`);
- применяется fps‑aware порог `min_scene_seconds` (или эквивалент через `min_scene_length_frames / fps`);
- дополнительно считаются робастные агрегаты: энтропии, gaps, доли high‑confidence кадров и стабильность лейблов.

