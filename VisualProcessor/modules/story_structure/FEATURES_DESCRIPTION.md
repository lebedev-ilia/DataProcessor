# Описание фичей модуля story_structure

## Baseline v1 (текущая реализация в пайплайне)

В baseline-режиме модуль **не использует локальные модели** (SentenceTransformer/кластеризацию) и строит
сигнал “энергии истории” по **изменениям `core_clip` embeddings** на кадрах `frame_indices`, заданных Segmenter.

Возвращаемые baseline-артефакты:
- `story_energy_curve`: z-score сглаженного embedding-diff сигнала (длина = `len(frame_indices)`)
- `embedding_diff_next`: cosine distance между соседними embeddings (длина = `len(frame_indices)-1`)
- `features`: агрегаты (hook/climax/peaks) + placeholders (NaN) для subtitle/topic фичей

Если субтитры не переданы — `subtitles_present=false`, а topic-фичи остаются `NaN`.

## 1. Story Segmentation (Сегментация истории)

### number_of_story_segments
Количество сегментов истории, на которые разделяется видео. Сегментация выполняется через иерархическую кластеризацию (AgglomerativeClustering) сглаженных CLIP-эмбеддингов кадров с использованием cosine similarity и average linkage. Число сегментов подбирается автоматически в разумном диапазоне, исходя из длины ролика и минимальной длительности сегмента.

### avg_story_segment_duration
Средняя длительность сегмента истории в кадрах, вычисляемая как среднее значение длительностей всех сегментов после пост-обработки (слияние слишком коротких сегментов).

### avg_story_segment_duration_normalized
Средняя длительность сегмента, нормализованная на длину видео:  
`avg_story_segment_duration_normalized = avg_story_segment_duration / total_frames`.  
Позволяет сравнивать ролики разной длины.

### abrupt_story_transition_count
Количество резких переходов между сегментами истории, определяемых как количество изменений меток кластеров между соседними кадрами **после** пост-обработки с минимальной длиной сегмента. Отражает количество разрывов в повествовании, при этом короткие «шумовые» сегменты сглаживаются.

### narrative_continuity_score
Оценка непрерывности повествования, вычисляемая как взвешенная по длине сегментов средняя cosine similarity между средними CLIP-эмбеддингами последовательных сегментов истории. Высокое значение указывает на плавные тематические переходы между сегментами.

### narrative_continuity_std
Стандартное отклонение оценок непрерывности повествования между последовательными сегментами. Показывает вариативность плавности переходов; при высокой корреляции с `narrative_continuity_score` может рассматриваться как вспомогательная фича.

## 2. Hook Features (Фичи начала видео)

### hook_motion_intensity
Интенсивность движения в начале видео, вычисляемая как среднее значение сглаженного модуля оптического потока Farneback в окне хука. Окно определяется как `min(5 секунд, 15% длины видео)` по реальному `fps`. Отражает общую динамичность начала для привлечения внимания.

### hook_cut_rate
Частота «резких» движений/монтажных склеек в начале видео, вычисляемая как число кадров с величиной оптического потока выше 75-го перцентиля в окне хука, делённое на длительность окна в секундах. Отражает темп монтажа в самом начале.

### hook_motion_spikes
Количество всплесков движения в начале видео, определяемых как число кадров с величиной оптического потока выше 90-го перцентиля внутри окна хука. Используется как вспомогательный счётчик пиков движения.

### hook_rhythm_score
Интегральная метрика «ритма» хука: нормализованная сумма значений оптического потока в пиковых кадрах (выше 90-го перцентиля), делённая на среднюю интенсивность движения в окне хука. Позволяет совмещать частоту и силу пиков в одном счёте.

### hook_face_presence
Доля кадров с присутствием лиц в начале видео, вычисляемая через MediaPipe FaceMesh только по окну хука. Показывает, используется ли присутствие людей как элемент привлечения внимания в первые секунды.

### hook_visual_surprise_score
Оценка визуальной неожиданности в начале видео, вычисляемая как среднее значение cosine distance между CLIP-эмбеддингами соседних кадров внутри окна хука. Высокое значение указывает на быстрые визуальные изменения.

### hook_visual_surprise_std
Стандартное отклонение визуальной неожиданности в начале, показывающее вариативность скорости визуальных изменений в окне хука.

### hook_brightness_spike
Нормализованный всплеск яркости в начале видео. Считается по V-каналу HSV внутри окна хука как z-score разности между максимальной и средней яркостью (разность делится на стандартное отклонение яркости в окне). Отражает использование яркости для привлечения внимания.

### hook_saturation_spike
Нормализованный всплеск насыщенности в начале видео. Аналогично яркости, но по S-каналу HSV: z-score разности между максимальной и средней насыщенностью в окне хука.

## 3. Climax Detection (Детекция кульминации)

### climax_timestamp
Временная метка кульминации в кадрах, определяемая как индекс кадра с максимальным значением комбинированного сигнала энергии истории (после сглаживания и поиска пиков). Комбинированный сигнал = сглаженный оптический поток + сглаженные изменения CLIP-эмбеддингов.

### climax_position_normalized
Нормализованная позиция кульминации в видео в диапазоне [0, 1]: `climax_timestamp / total_frames`. Позволяет сравнивать расположение кульминации между роликами разной длины.

### climax_strength
Сырая сила кульминации, определяемая как значение комбинированного сигнала энергии истории в кадре кульминации. Отражает абсолютную интенсивность кульминационного момента.

### climax_strength_normalized
Нормализованная сила кульминации, выраженная в z-score относительно среднего и стандартного отклонения комбинированного сигнала по видео. Делает метрику сопоставимой между роликами с разным общим уровнем «энергии».

### number_of_peaks
Количество пиков энергии в истории, определяемых как количество кадров со значением комбинированного сигнала выше 90-го перцентиля по видео. Указывает на количество интенсивных эпизодов.

### climax_duration
Длительность кульминации в кадрах, определяемая как количество кадров со значением комбинированного сигнала выше 75-го перцентиля (высокоэнергетическая область). Показывает протяженность зоны кульминации.

### time_from_hook_to_climax
Время от окончания окна хука до кадра кульминации, нормализованное на длину видео (в долях от 0 до 1). Если кульминация попадает в окно хука, значение равно 0.

### hook_to_avg_energy_ratio
Отношение средней энергии комбинированного сигнала в окне хука к средней энергии по всему видео. Показывает, насколько начало видео более/менее энергично по сравнению с остальной частью.

### story_energy_curve
Кривая энергии истории, представляющая собой список значений комбинированного сигнала (оптический поток + изменения эмбеддингов) по всем кадрам после сглаживания. Отражает динамику интенсивности повествования во времени и предназначена для подачи в последовательностные модели (например, трансформер).

### story_energy_curve_downsampled_128
Версия `story_energy_curve`, адаптивно downsample-ленная (интерполяцией) до длины 128 точек. Удобна для подачи в VisualTransformer без дополнительной предобработки.

## 4. Character Features (Фичи персонажей)

### number_of_unique_identities
Приближённое количество уникальных персонажей в видео. В текущей реализации оценивается как максимальное количество лиц, одновременно присутствующих в кадре (через MediaPipe FaceMesh). При появлении устойчивого трекинга/кластеризации лиц может быть заменено на реальное число идентичностей.

### main_character_screen_time
Приближённое экранное время главного персонажа, вычисляемое как доля кадров, в которых присутствует хотя бы одно лицо. В отсутствие явной идентичности интерпретируется как доля времени, когда в кадре есть люди (часто коррелирует с screen time основного спикера).

### speaker_switch_rate
Приближённая частота смены говорящих, вычисляемая как доля кадров, где меняется факт присутствия лиц (есть/нет) по сравнению с предыдущим кадром. Отражает динамику появления и исчезновения людей в кадре; в дальнейшем может быть заменена на метрику на уровне ID.

### face_presence_curve
Кривая присутствия лиц: список количества лиц в каждом кадре видео. Позволяет отслеживать динамику появления/исчезновения персонажей во времени.

### face_area_fraction_curve
Кривая доли площади лиц в кадре: для каждого кадра считается суммарная площадь всех обнаруженных лиц (по боксам, восстановленным из FaceMesh), делённая на площадь кадра. Даёт более чувствительный сигнал к «близости» и доминированию лиц в кадре, чем просто счётчик лиц.

## 5. Topic Features (Фичи тем)

### has_subtitles
Бинарный флаг наличия исходных текстовых данных (субтитров/ASR). Если `False`, все численные topic-фичи выставляются в `NaN` (или эквивалент) и не должны использоваться напрямую без маски.

### number_of_topics
Количество различных тем в видео, определяемое через иерархическую кластеризацию (AgglomerativeClustering) SentenceTransformer-эмбеддингов субтитров. Используется фиксированное максимальное число кластеров, адаптированное к числу субтитров.

### avg_topic_duration
Средняя длительность темы в «юнитах субтитров», вычисляемая как среднее значение размеров всех кластеров тем.

### avg_topic_duration_normalized
Средняя длительность темы, нормализованная на общее количество субтитров: `avg_topic_duration / N_subtitles`. Помогает сравнивать ролики с разной плотностью субтитров.

### topic_shift_times
Индексы субтитров, в которых происходит смена темы (изменение метки кластера по сравнению с предыдущей субтитрой). Указывает на последовательность переходов между различными темами повествования.

### topic_diversity
Базовое разнообразие тем, вычисляемое как отношение количества уникальных тем к общему количеству субтитров: `num_topics / N_subtitles`.

### topic_diversity_normalized
Нормализованное разнообразие тем: `num_topics / log(N_subtitles + 1)`. Менее чувствительно к высокой плотности коротких субтитров и лучше отражает реальное разнообразие содержания.

### semantic_coherence_score
Взвешенная по размеру тем оценка семантической связности: средняя cosine similarity между эмбеддингами субтитров внутри каждой темы, усреднённая по темам с весом пропорциональным размеру темы. Высокое значение указывает на семантически однородные темы.

### topic_coherence_std
Стандартное отклонение по значениям связности отдельных тем. Позволяет оценить, насколько одни темы «сильно собраны», а другие более размыты.

