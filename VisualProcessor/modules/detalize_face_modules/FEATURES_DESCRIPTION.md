# Описание фичей модуля detalize_face_modules

Модуль использует MediaPipe FaceMesh для детекции 468 ключевых точек лица и модульную архитектуру для извлечения различных типов фич. Все фичи вычисляются на основе координат landmarks (468 точек) и области лица (ROI).

## Общие принципы

### Temporal History
Многие метрики требуют истории — используются фиксированные окна (рекомендуемые: 30 кадров ≈ 1–1.5 с при 25–30 fps) и экспоненциальное скользящее среднее для быстрого обновления.

### Сжатие landmark-векторов
Не передавать 468×2 raw для каждого кадра в трансформер. Используется PCA/AE/learned projection для сжатия до 8–16 dims.

### Оптимизация вычислений
Подробные/дорогие метрики (3D-реконструкция, phoneme inference, heavy texture analysis) вычисляются на сэмплах (каждые N кадров) либо только для primary face.

### Мульти-лицо
Выделяется primary face (наибольшая bbox_area) + N вторичных (обычно N=2). Агрегаты по-видео дают статистики для primary и max/mean по top-K faces.

## 1. Базовые метаданные

### frame_index
Индекс кадра в видео, к которому относятся детекции лиц.

### face_index
Индекс лица в кадре (в одном кадре может быть обнаружено до 10 лиц, по умолчанию).

### bbox
Координаты ограничивающего прямоугольника лица [x_min, y_min, x_max, y_max] в пикселях исходного кадра, вычисляемые на основе крайних точек landmarks.

### detection_confidence
Уверенность детекции лица (0.0-1.0). Используется для взвешивания метрик и фильтрации низкокачественных детекций.

### tracking_id
Идентификатор трека лица для мульти-кадровой агрегации. Назначается на основе IoU bbox между кадрами.

### is_primary_face
Булево значение, указывающее, является ли данное лицо primary face (наибольшая площадь bbox в кадре).

## 2. Geometry Module (Геометрические фичи)

Все геометрические фичи вычисляются на основе координат landmarks и bbox лица.

### face_bbox_area
Площадь ограничивающего прямоугольника лица, вычисляемая как произведение ширины и высоты bbox. Отражает абсолютный размер лица в пикселях.

### face_relative_size
Относительный размер лица в кадре, вычисляемый как отношение площади bbox к площади кадра. Нормализованное значение от 0 до 1, показывающее долю кадра, занимаемую лицом.

### face_box_ratio
Соотношение сторон bbox (width/height), характеризующее форму прямоугольника, ограничивающего лицо. Значение близкое к 1.0 указывает на квадратную форму.

### face_bbox_position
Координаты центра bbox (cx, cy), вычисляемые как среднее между минимальными и максимальными координатами. Показывает позицию лица в кадре.

### face_center_x_norm, face_center_y_norm
Нормализованные координаты центра лица (0-1), вычисляемые как cx/frame_width и cy/frame_height.

### face_dist_from_center
Нормализованное расстояние от центра bbox до центра кадра. Вычисляется как евклидово расстояние, нормализованное на максимальный размер кадра. Показывает, насколько лицо смещено от центра кадра.

### face_rotation_in_frame
Угол поворота лица в плоскости кадра (в градусах), вычисляемый через arctan2 между крайними точками внешних углов глаз. Отрицательные значения указывают на наклон влево, положительные - вправо.

### aspect_ratio_stability
Оценка стабильности соотношения сторон лица во времени, вычисляемая как 1.0 минус нормализованное стандартное отклонение истории соотношений сторон. Требует истории из нескольких кадров для одного лица (окно 30 кадров).

### jaw_width, cheekbone_width, cheek_width, forehead_height
Ширина различных частей лица и высота лба, вычисляемые как евклидово расстояние между соответствующими парами landmarks. Отражают морфометрические характеристики лица.

### jaw_width_norm, cheekbone_width_norm, cheek_width_norm, forehead_height_norm
Нормализованные версии морфометрических метрик (делятся на bbox diagonal для нормализации по масштабу).

### face_shape_vector
Вектор формы лица, представляющий сжатую проекцию координат ключевых точек овала лица (36 landmarks → 16 dims через PCA/projection). Характеризует форму лица в компактном виде.

### landmark_stability
Оценка стабильности landmarks, вычисляемая как fraction of missing/low-confidence points. Использует detection_confidence как proxy.

## 3. Pose Module (Поза головы)

Фичи позы вычисляются на основе анализа 3D координат landmarks лица для определения ориентации головы.

### yaw, pitch, roll
Углы Эйлера, характеризующие ориентацию головы: yaw (поворот влево/вправо), pitch (наклон вверх/вниз), roll (наклон вокруг оси). Вычисляются через комбинацию 2D и 3D анализа.

### yaw_norm, pitch_norm, roll_norm
Нормализованные углы (делятся на 90 градусов), значения в диапазоне [-1, 1].

### head_pose_variability
Вариативность позы головы во времени, вычисляемая как среднее стандартное отклонение по всем трем углам в истории поз (окно 30 кадров). Показывает, насколько стабильна поза головы.

### pose_stability_score
Оценка стабильности позы, основанная на отклонении yaw от 0 (прямой взгляд). Вычисляется как 1.0 минус нормализованное отклонение yaw (деленное на 45 градусов). Высокое значение указывает на стабильную, прямую позу.

### head_turn_frequency
Частота поворотов головы, вычисляемая как доля кадров с изменением yaw более чем на 7 градусов (настраиваемый порог) по сравнению с предыдущим кадром. Отражает динамику движений головы.

### attention_to_camera_ratio
Оценка внимания к камере, основанная на yaw. Вычисляется через экспоненциальную функцию от нормализованного yaw, давая максимальное значение при yaw=0 (взгляд прямо в камеру).

### looking_direction_vector
Нормализованный 3D unit-вектор направления взгляда, вычисляемый как нормализованная разность координат между правым и левым глазом [dx, dy, dz]. Отражает направление, в котором "смотрит" лицо в 3D пространстве.

### pose_conf, landmark_conf, tracking_conf
Confidence метрики для позы, landmarks и трекинга (используют detection_confidence как proxy).

## 4. Quality Module (Качество изображения)

Фичи качества вычисляются на основе анализа области лица (ROI) в градациях серого. Все метрики нормализованы в стандартизованную шкалу [0..1].

### face_sharpness
Объединенная метрика резкости, комбинирующая blur_score (дисперсия Лапласиана) и sharpness_score (оператор Собеля). Вычисляется как 0.6 * blur_score + 0.4 * sharpness_score.

### face_noise_level
Оценка уровня шума, вычисляемая как стандартное отклонение разности между оригинальным и размытым (Gaussian blur 5x5) изображением. Нормализуется на 40.

### face_exposure_score
Оценка экспозиции, основанная на средней яркости и контрасте. Хорошая экспозиция: средняя яркость около 0.5, достаточный контраст.

### occlusion_proxy
Улучшенная оценка окклюзии (перекрытия лица), вычисляемая как fraction of landmarks with low confidence + visible mouth/eyes fraction. Более точная, чем просто 1 - visibility_ratio.

### quality_proxy_score
Комплексная оценка качества, комбинирующая face_sharpness, face_noise_level, face_exposure_score и occlusion_proxy для получения единой оценки качества изображения лица.

### quality_confidence
Confidence метрика для качества (использует detection_confidence).

### Обратная совместимость
Старые метрики (face_blur_score, sharpness_score, noise_level, face_visibility_ratio) сохранены для обратной совместимости, но рекомендуется использовать новые объединенные метрики.

## 5. Lighting Module (Освещение)

Фичи освещения вычисляются на основе анализа яркости, цвета и распределения света в области лица.

### average_lighting_on_face
Средняя яркость области лица, вычисляемая как среднее значение яркости (V канал HSV) в ROI. Отражает общий уровень освещенности лица.

### light_uniformity_score
Оценка равномерности освещения, вычисляемая через анализ распределения яркости по зонам лица (лоб, щеки, подбородок). Высокие значения указывают на равномерное освещение.

### face_contrast
Контраст лица, вычисляемый как стандартное отклонение яркости в ROI, нормализованное на 255. Отражает разброс яркостей, характеризующий контрастность изображения.

### white_balance_shift
Сдвиг баланса белого, вычисляемый как разности между средними значениями RGB каналов (r_minus_g, r_minus_b, g_minus_b). Отражает цветовую температуру освещения.

### highlight_intensity
Интенсивность бликов на лице, вычисляемая как максимальная яркость в области лица, нормализованная на 255. Отражает наличие ярких отражений света.

### shadow_depth
Глубина теней, вычисляемая как разность между средней и минимальной яркостью в ROI. Отражает наличие затемненных областей на лице.

### glare_score
Оценка бликов, вычисляемая через анализ переэкспонированных областей (яркость выше порога) в ROI. Высокие значения указывают на сильные блики.

### shading_score
Оценка затенения, вычисляемая через анализ распределения яркости по зонам лица. Высокие значения указывают на плавное, естественное затенение.

### lighting_proxy_score
Комплексная оценка освещения, комбинирующая различные метрики освещения для получения единой оценки качества освещения.

### zone_lighting
Освещение по зонам лица, представляющее среднюю яркость лба, щек и подбородка. Позволяет анализировать распределение света по различным частям лица.

### skin_tone_index (AUDIT-ONLY)
**ВНИМАНИЕ**: Эта метрика чувствительна и может быть использована только для аудита. Не используется в рабочей модели без юридической проверки и bias-анализа. По умолчанию отключена.

## 6. Skin Module (Кожа)

Фичи кожи вычисляются на основе анализа текстуры, цвета и наличия макияжа в области лица. Используются только non-sensitive фичи.

### skin_smoothness
Гладкость кожи (техническая метрика), вычисляемая через анализ текстуры кожи (стандартное отклонение градиентов или локальная вариативность). Высокие значения указывают на гладкую кожу. Не связана с привлекательностью.

### face_hair_density
Общая плотность растительности на лице (beard + mustache). Бинарная/плотность растительности.

### beard_prob, mustache_prob
Вероятности наличия бороды и усов, вычисляемые через анализ текстуры и цвета в соответствующих областях (подбородок, верхняя губа, щеки).

### makeup_presence_prob, lipstick_intensity, eye_shadow_prob
**С осторожностью**: Вероятности наличия макияжа, интенсивность помады и вероятность теней для глаз. Могут помочь классификации format/style (бьюти-видео vs влоги), но чувствительны. Требуют аудита.

### eyebrow_shape_vector
Вектор формы бровей, представляющий координаты ключевых точек бровей. Характеризует форму, изгиб и положение бровей.

### eyelid_openness
Открытие век, вычисляемое как расстояние между верхним и нижним веком, нормализованное относительно размера глаза. Отражает степень открытия глаз.

### Удалено
- **skin_defect_score**: Удален как рискованная метрика, может быть дискриминационной.

## 7. Accessories Module (Аксессуары)

Фичи аксессуаров вычисляются через анализ соответствующих областей лица на наличие характерных признаков аксессуаров.

### glasses_prob, sunglasses_prob
Вероятности наличия очков и солнцезащитных очков, вычисляемые через анализ области вокруг глаз на наличие характерных признаков (рамки, затемнение, отражения).

### mask_prob
Вероятность наличия маски, вычисляемая через анализ области носа и рта на наличие закрывающего материала.

### hat_prob, helmet_prob
Вероятности наличия шапки и шлема, вычисляемые через анализ области лба и верхней части головы на наличие характерных признаков.

### earrings_presence, earrings_prob
Наличие и вероятность серег, вычисляемые через анализ области ушей на наличие характерных объектов.

### jewelry_probability
Вероятность наличия украшений, общая оценка наличия различных типов украшений (серьги, ожерелья и т.д.).

### hair_accessories
Оценка наличия аксессуаров для волос, вычисляемая через анализ области головы на наличие характерных признаков.

## 8. Eyes Module (Глаза)

Фичи глаз вычисляются на основе анализа landmarks глаз и век. Критичные предикторы вовлечённости.

### eye_opening_ratio
Соотношение открытия глаз для левого и правого глаза, а также среднее значение. Вычисляется как отношение высоты открытия к нормализованному размеру глаза. Отражает степень открытия каждого глаза.

### eye_opening_left, eye_opening_right
Нормализованные значения открытия глаз (0-1), вычисляемые как eye_opening / 20.0.

### blink_rate
Частота моргания (blinks per minute), вычисляемая через улучшенный алгоритм с использованием временного окна 1–2 секунды и hysteresis для предотвращения множественных детекций одного моргания.

### blink_intensity
Интенсивность моргания, вычисляемая как стандартное отклонение истории открытия глаз.

### blink_flag
Булево значение, указывающее, происходит ли моргание в текущем кадре.

### last_blink_timestamp
Временная метка последнего моргания (в секундах относительно начала окна истории).

### gaze_vector
3D вектор направления взгляда, вычисляемый на основе позиции радужки относительно центра глаза и позы головы. Характеризует направление, в котором смотрит человек.

### gaze_at_camera_prob
Вероятность взгляда в камеру, вычисляемая через анализ gaze_vector и позы головы. Высокие значения указывают на прямой взгляд в камеру. Критичный предиктор вовлечённости.

### attention_score
Оценка внимания, комбинирующая gaze_at_camera_prob, eye_opening_ratio и другие факторы для оценки уровня внимания и фокусировки.

### iris_position
Позиция радужки в глазу для левого и правого глаза, вычисляемая как нормализованное смещение центра радужки относительно центра глаза. Отражает направление взгляда в плоскости глаза.

### Удалено
- **eye_redness_prob**: Удален как не нужный для модели (чувствительный/irrelevant).

## 9. Motion Module (Движение)

Фичи движения вычисляются через анализ изменений координат landmarks во времени (требуют временной истории).

### face_speed, face_acceleration
Скорость и ускорение движения лица, вычисляемые как первая и вторая производные позиции центра лица (bbox center) по времени. Отражают линейное движение лица в кадре.

### micro_expression_rate
Частота микро-выражений, вычисляемая через анализ быстрых изменений в expression_vector (из StructureModule) во времени. Потенциально полезен, но дорог и шумен; вычисляется как опциональный агрегат.

### jaw_movement_intensity
Интенсивность движения челюсти, вычисляемая через анализ изменения расстояния между верхней и нижней губой или изменений в landmarks челюсти.

### eyebrows_motion_score, mouth_motion_score
Оценки движения бровей и рта, вычисляемые через анализ изменений соответствующих landmarks во времени.

### head_motion_energy
Энергия движения головы, вычисляемая как комбинация изменений позы (yaw, pitch, roll) во времени. Отражает общую динамику движений головы. Сильно коррелирует с энергией сцены.

### talking_motion_score
Оценка движения, связанного с речью, вычисляемая через комбинацию mouth_motion_score, jaw_movement_intensity и других признаков речи. Сильно коррелирует с энергией сцены.

## 10. Structure Module (Структура)

Структурные фичи вычисляются на основе нормализованных координат landmarks для характеристики формы и выражения лица. Векторы сжаты для компактности.

### face_mesh_vector
Вектор mesh лица, представляющий сжатую проекцию нормализованных координат первых 100 landmarks (сжато до 32 dims). Характеризует общую структуру лица.

### identity_shape_vector
Вектор идентичности формы (privacy-preserving). При включенном use_privacy_preserving возвращает хеш (SHA-256) вместо raw вектора для предотвращения re-ID. При выключенном — сжатая проекция (16 dims). Характеризует базовую, неизменную форму лица (структурные особенности).

### expression_vector
Вектор выражения, вычисляемый как разность между нормализованными координатами landmarks выражения (50-100) и landmarks идентичности (0-50), сжатый до 8 dims. Характеризует текущее выражение лица, независимо от базовой формы.

### jaw_pose_vector, eye_pose_vector
Векторы позы челюсти и глаз, извлекаемые из pose (yaw, pitch, roll для челюсти; pitch, roll для глаз). Характеризуют ориентацию соответствующих частей лица.

### mouth_shape_params
Параметры формы рта, вычисляемые как разность между максимальными и минимальными координатами landmarks рта (width, height). Характеризуют размер и форму рта.

### face_symmetry_score
Оценка симметрии лица, вычисляемая через сравнение левой и правой половин лица (отражение координат и сравнение). Высокие значения указывают на симметричное лицо. **С осторожностью**: коррелирует с attractiveness и bias. Используется как техническая фича с аудитом.

### face_uniqueness_score
Оценка уникальности лица, вычисляемая как стандартное отклонение нормализованных координат landmarks. Отражает вариативность формы лица.

### identity_params_count, expression_params_count
Количество параметров в векторах идентичности и выражения. Метаданные о размерности векторов.

### face_dimensions
Размеры лица (width, height, depth, aspect_ratio), вычисляемые на основе размаха координат landmarks. Характеризуют общие пропорции лица.

## 11. Professional Module (Профессиональные фичи)

Профессиональные фичи комбинируют различные аспекты для оценки качества и состояния лица. Вычисляются как downstream meta-features (предпочтительнее через learned classifier/ensembling на top of base features).

### face_quality_score
Комплексная оценка качества лица, комбинирующая метрики из QualityModule (face_sharpness, face_noise_level, face_exposure_score). Отражает общее качество изображения и видимости лица.

### emotion_intensity
Интенсивность эмоции, вычисляемая через анализ expression_vector и других признаков выражения лица (motion, mouth_motion_score, eyebrows_motion_score).

### lip_reading_features
Фичи для чтения по губам (mouth_openness, mouth_motion_intensity, jaw_movement, speech_activity_prob), извлекаемые из LipReadingModule. Характеризуют активность речи.

### fatigue_score, fatigue_breakdown
Оценка усталости и её разбивка по компонентам (eye_fatigue, pose_fatigue, motion_fatigue, temporal_fatigue). Вычисляется через комбинацию eye_closedness, head_pitch_down, low_motion_speed, blink_abnormality и других признаков усталости.

### engagement_level
Уровень вовлеченности, вычисляемый через комбинацию gaze_score, attention, micro_expressions, mouth_motion и eye_opening. Критичный предиктор вовлечённости.

### alertness_score, expressiveness_score
Оценки бдительности и выразительности, вычисляемые через комбинацию различных фич (взгляд, поза, движение, выражение).

### Удалено
- **perceived_attractiveness_score**: Удален как рискованная метрика, может быть дискриминационной. Рекомендация: compute high-level scores via learned model on module outputs; keep audit trail.

## 12. Lip Reading Module (Чтение по губам)

Фичи для чтения по губам вычисляются на основе анализа формы и движения рта. Очень полезны для speech detection and engagement.

### mouth_width, mouth_height, mouth_area
Ширина, высота и площадь рта, вычисляемые на основе landmarks губ. Характеризуют размер рта.

### mouth_aspect_ratio
Соотношение сторон рта (height/width), характеризующее форму рта.

### lip_separation
Расстояние между верхней и нижней губой, отражающее степень открытия рта.

### lip_asymmetry
Асимметрия губ, вычисляемая через сравнение левой и правой половин рта.

### lip_contour_compactness
Компактность контура губ, вычисляемая как отношение площади к периметру контура губ.

### lip_prominence_ratio
Отношение выступа губ, характеризующее их объемность.

### phoneme_features
Фичи, напоминающие фонемы (round_shape, wide_shape, narrow_shape, open_shape), вычисляемые на основе формы рта. Характеризуют форму рта, соответствующую различным звукам. **Дорогие**: делать только если есть ресурс и явная потребность.

### mouth_motion_intensity, width_velocity, height_velocity, area_velocity
Интенсивность движения рта и скорости изменения ширины, высоты и площади рта во времени.

### cycle_strength
Сила цикличности движения рта, вычисляемая через анализ периодичности изменений формы рта. Отражает ритмичность речи.

### speech_activity_prob
Вероятность речевой активности, вычисляемая через комбинацию mouth_motion_intensity, cycle_strength и других признаков речи. **Высокий приоритет** для прогнозирования речевой активности и вовлечения.

### width_variance, height_variance, area_variance, separation_variance
Вариативность параметров рта во времени, вычисляемые как дисперсия соответствующих параметров. Отражают динамику изменений рта.

## 13. Face 3D Module (3D реконструкция)

Фичи 3D реконструкции представляют упрощенную версию 3D Morphable Model (3DMM) для характеристики 3D структуры лица. **Опционально**: вычислять только когда надежная глубина/3D доступна.

### face_mesh_vector (3D)
3D вектор mesh лица, представляющий сжатую проекцию 3D координат landmarks (обычно первые 100 точек с координатами x, y, z), сжатый до 16–32 dims. Характеризует 3D структуру лица.

### identity_shape_vector (3D)
3D вектор идентичности формы, представляющий сжатую проекцию 3D координат структурных landmarks. Характеризует базовую 3D форму лица. **Privacy-preserving**: применяется hashing для предотвращения re-ID.

### expression_vector (3D)
3D вектор выражения, представляющий отклонения от базовой формы, сжатый до 8–16 dims. Характеризует 3D деформации, связанные с выражением лица.

### jaw_pose_vector, eye_pose_vector (3D)
3D векторы позы челюсти и глаз, извлекаемые из pose. Характеризуют 3D ориентацию соответствующих частей лица.

### mouth_shape_params (3D)
3D параметры формы рта, включающие ширину, высоту, глубину и другие измерения в 3D пространстве.

### face_symmetry_score (3D)
3D оценка симметрии лица, вычисляемая через сравнение левой и правой половин лица в 3D пространстве.

### face_uniqueness_score (3D)
3D оценка уникальности, основанная на 3D структуре лица.

### mesh_num_vertices, identity_params_count, expression_params_count (3D)
Метаданные о размерности 3D векторов (количество вершин mesh, параметры идентичности и выражения).

## Компактный набор фичей для VisualTransformer (~48 dims)

Для использования в VisualTransformer доступна функция `extract_compact_features()`, которая извлекает компактный набор фичей (~42-48 dims):

- **face_embedding_proj** (16 dims) - проекция PCA/learned от normalized landmarks
- **yaw_norm, pitch_norm, roll_norm** (3 dims)
- **gaze_at_camera_prob** (1 dim)
- **eye_opening_left, eye_opening_right** (2 dims)
- **mouth_opening_ratio** (1 dim)
- **face_size_rel** (1 dim)
- **face_center_x_norm, face_center_y_norm** (2 dims)
- **face_sharpness** (1 dim)
- **face_noise_level** (1 dim)
- **occlusion_proxy** (1 dim)
- **glasses_prob** (1 dim)
- **mask_prob** (1 dim)
- **face_motion_speed_norm** (1 dim)
- **head_motion_energy_norm** (1 dim)
- **expression_proj** (8 dims) - проекция expression_vector
- **detection_confidence** (1 dim)

Итого: ~42 dims.

## Практические детали реализации

### History windows
- Blink detection: 1–2s (30–60 frames at 30fps)
- Head variability window: 30–60 frames
- Speech activity window: 0.5–1s

### Sampling
- Compute heavy ops (texture analysis, makeup detectors) every 3–5 frames
- Full landmark compression every frame

### Tracking
- Track faces with tracking_id via IoU of bbox and face_embedding similarity (cosine on embedding_proj)
- Keep track life: if disappeared > 30 frames — close track

### Missing data
- При пропусках интерполировать pose через last-known + smoothing
- Отмечать interpolation_flag

### Normalization
- Все размерные метрики делить на bbox diagonal или кадр-ширину/высоту
- Затем clip to [0..1]

### Confidence
- Propagate detection_confidence → weight для агрегатов (weighted mean)

## Этика / Privacy / Bias

### Удалено или помечено как audit-only
- **perceived_attractiveness_score**: Удален — большие риски дискриминации и юридических проблем
- **skin_tone_index**: Помечен как audit-only — чувствительная/этичная фича
- **skin_defect_score**: Удален — рискованная метрика

### Рекомендации
- Любые метрики, связанные с «полом», «раской», «привлекательностью» — должны быть документированы, иметь justification и bias-audit
- Для identity-ориентированных векторов (identity_shape_vector) применяется privacy-preserving hashing или минимальная размерность
- Исключено хранение raw face embeddings, если есть GDPR/CCPA риски

## Примечания

- Все фичи вычисляются для каждого обнаруженного лица в каждом кадре
- Временные фичи (motion, blink_rate, stability и т.д.) требуют истории кадров для одного лица (отслеживание через tracking_id)
- MediaPipe FaceMesh предоставляет 468 landmarks (или 468 при refine_landmarks=True), которые используются как основа для всех вычислений
- Модульная архитектура позволяет выборочно включать/отключать модули для оптимизации производительности
- Primary face определяется как лицо с наибольшей bbox_area в каждом кадре
