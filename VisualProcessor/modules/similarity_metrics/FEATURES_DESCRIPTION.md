# Описание фичей модуля similarity_metrics

Модуль вычисляет метрики схожести между текущим видео и набором референсных видео по различным аспектам: семантика, темы, визуальный стиль, текст, аудио, эмоции, временной ритм.

## Baseline v1 (текущая реализация в пайплайне)

Для baseline (первый цикл) модуль работает в режиме:
- **intra-video coherence** на основе `core_clip`
- + optional reference similarity, если передан `--reference-embeddings-npz`

Ключевые baseline-метрики:
- `centroid_sim_*`: схожесть каждого кадра к “центроиду” видео (coherence)
- `temporal_sim_*`: схожесть соседних кадров (стабильность во времени)
- `reference_similarity_*`: если задан reference set

## 1. Semantic Similarity

### semantic_similarity_mean
Средняя косинусная схожесть embeddings текущего видео с топ-N референсными видео. Вычисляется как среднее значение схожестей с top-N наиболее похожими видео.

### semantic_similarity_max
Максимальная схожесть с любым референсным видео. Показывает максимальную семантическую близость.

### semantic_similarity_p10
10‑й перцентиль семантической схожести по всем референсным видео. Более устойчивая альтернатива `min`, отражающая «хвост» распределения схожести (насколько далеко видео от основной массы референсов).

### semantic_novelty_score
Оценка новизны видео, основанная на максимальной семантической схожести. Нормализуется в диапазон [0,1] на основе \(1 - \mathrm{max\_similarity}\) (выше = более уникально). Рекомендуется использовать совместно с кластерными/дистрибутивными метриками новизны.

## 2. Topic / Concept Overlap

### topic_overlap_score
Взвешенный Jaccard-пересечений тем между текущим и референсными видео. Используются веса важности/вероятности тем (из topic-модели или TF-IDF), пересечения и объединения считаются по взвешенным суммам.

### topic_diversity_comparison
Разница в тематическом разнообразии между текущим и референсными видео. Вычисляется через нормализованную разницу энтропий распределений тем (Shannon entropy) текущего и референсного видео.

### key_concept_match_ratio
Взвешенная доля совпадающих ключевых концептов. Вычисляется как отношение суммарного веса пересечения концептов к суммарному весу концептов текущего видео (учитывает важность/частоту концептов).

## 3. Style & Composition Similarity

### color_histogram_similarity
Схожесть цветовых гистограмм. Вычисляется через косинусную схожесть нормализованных гистограмм цветов.

### lighting_pattern_similarity
Схожесть паттернов освещения. Вычисляется через косинусную схожесть фичей освещения.

### shot_type_distribution_similarity
Схожесть распределения типов кадров. Вычисляется через Earth Mover's Distance между распределениями типов кадров.

### cut_rate_similarity
Схожесть частоты склеек. Вычисляется через нормализованную разницу частот склеек.

### motion_pattern_similarity
Схожесть паттернов движения. Вычисляется через корреляцию Пирсона между кривыми движения.

## 4. Text & OCR Similarity

### ocr_text_semantic_similarity
Семантическая схожесть OCR текста. Вычисляется через косинусную схожесть embeddings текста.

### text_layout_similarity
Схожесть расположения текста (позиции, длина, размер шрифта). Вычисляется через косинусную схожесть фичей layout.

### text_timing_similarity
Схожесть временных паттернов появления текста. Вычисляется через корреляцию Пирсона между кривыми появления текста.

## 5. Audio / Speech Similarity

### audio_embedding_similarity
Схожесть аудио embeddings. Вычисляется через косинусную схожесть аудио embeddings.

### speech_content_similarity
Схожесть содержания речи (по ASR). Вычисляется через косинусную схожесть speech embeddings.

### music_tempo_similarity
Схожесть темпа музыки. Вычисляется через нормализованную разницу темпов.

### audio_energy_pattern_similarity
Схожесть паттернов аудио энергии. Вычисляется через корреляцию Пирсона между кривыми энергии.

## 6. Emotion & Behavior Similarity

### emotion_curve_similarity
Схожесть кривых эмоций. Вычисляется через корреляцию Пирсона между кривыми эмоций.

### pose_motion_similarity
Схожесть движения поз. Вычисляется через косинусную схожесть фичей движения поз.

### behavior_pattern_similarity
Схожесть паттернов поведения. Вычисляется через корреляцию Пирсона между кривыми поведения.

## 7. Temporal / Pacing Similarity

### pacing_curve_similarity
Схожесть кривых pacing. Вычисляется через корреляцию Пирсона между кривыми pacing.

### shot_duration_distribution_similarity
Схожесть распределения длительностей кадров. Вычисляется через Earth Mover's Distance между распределениями.

### scene_length_similarity
Схожесть длительностей сцен. Вычисляется через сравнение средних и стандартных отклонений длительностей сцен (mean/std) с нормализацией по масштабу.

### temporal_pattern_novelty
Новизна временного паттерна: 1.0 - mean_pacing_similarity. Показывает уникальность временного ритма относительно референсов (выше = более уникальный pacing).

## 8. High-level Comparative Scores

### overall_similarity_score
Общая эвристическая оценка схожести, вычисляемая как взвешенная сумма метрик по категориям:
- semantic: 25%
- topics: 15%
- visual: 15%
- text: 10%
- audio: 15%
- emotion: 10%
- temporal: 10%

### uniqueness_score
Оценка уникальности: 1.0 - overall_similarity_score. Рекомендуется использовать как дополнительный агрегат, а не как единственный источник правды (в production желательно обучать отдельный агрегатор).

### trend_alignment_score
Оценка соответствия трендам. По умолчанию совпадает с `overall_similarity_score`; в production рекомендуется обучать отдельную метрику с учётом recency и популярности референсов.

### viral_pattern_score
Оценка схожести с вирусными видео. По умолчанию совпадает с `overall_similarity_score`; может быть уточнена через отдельный supervised‑классификатор/siamese‑модель над метриками схожести и метаданными референсных видео.

## 9. Group / Batch Metrics

### cluster_similarity_mean
Средняя схожесть между всеми парами видео в батче. Показывает кластерную схожесть набора видео.

### inter_video_variance_topics
Межвидео дисперсия по темам. Показывает разнообразие тем в батче.

### inter_video_variance_emotions
Межвидео дисперсия по эмоциям. Показывает разнообразие эмоций в батче.

### inter_video_variance_editing
Межвидео дисперсия по монтажу (частота склеек). Показывает разнообразие стилей монтажа в батче.

### inter_video_variance_audio
Межвидео дисперсия по аудио (темп). Показывает разнообразие аудио характеристик в батче.

## Методы вычисления

1. **Embedding Comparison**: Используется косинусная схожесть для сравнения embeddings.
2. **Distribution Comparison**: Используется Earth Mover's Distance для сравнения распределений.
3. **Curve Comparison**: Используется корреляция Пирсона для сравнения временных кривых.
4. **Set Comparison**: Используется Jaccard similarity для сравнения множеств тем/концептов.
5. **Top-N Averaging**: Метрики усредняются по топ-N наиболее похожим видео для устойчивости.

## Зависимости

- **numpy**: Для численных вычислений
- **scipy**: Для статистических метрик (correlation, distance)
- **sklearn**: Для вычисления схожести

## Использование

Модуль требует:
- **video_embedding**: Embedding текущего видео (может быть получен из high_level_semantic модуля)
- **reference_embeddings**: Список embeddings референсных видео (из файла JSON)
- Опционально: фичи из других модулей для более детального сравнения

Модуль может использовать данные из других модулей через флаги:
- `--use-high-level-semantic`: Использовать результаты high_level_semantic для video embedding
- `--use-text-scoring`: Использовать результаты text_scoring для text features
- `--use-visual-features`: Использовать визуальные фичи из других модулей

