## AudioProcessor – Документация шестой фазы

### Цель фазы
Довести пайплайн до «продуктового» состояния: стабилизировать GPU/CPU гибридную работу, унифицировать fallbacks, стандартизировать сериализацию больших матриц, усилить метрики производительности и качество логирования, подготовить отчётность и чек-листы для релиза.

### Ключевые результаты
- Единая политика fallbacks по зависимостям (Essentia, pyloudnorm, SpeechBrain, Open-Unmix)
- Стандартизированная сериализация больших массивов: сохранение в `.npy`, ссылки в manifest
- Расширенные агрегаты для фич (chroma, mel, loudness, band_energy, key, hpss)
- Устойчивые к NaN/inf вычисления, численная стабильность (mel stats, autocast)
- Отчёты производительности CPU vs GPU (total и per-extractor), трекинг ускорения
- Улучшенное логирование путей выполнения и параметров (device, fallbacks, сохранения)

### Изменения по экстракторам (итог фазы)
- mel: GPU-aware, autocast, mix-to-mono, сохранение больших матриц в `.npy`, компактные вектора статистик
- loudness: безопасный pyloudnorm fallback, frame-wise RMS статистики и вектор
- key: shared chroma support, beat-sync, tuning, распределение по 24 ключам, top-k
- hpss: shared STFT, реконструкция временных сигналов, `hpss_kwargs`, сохранение `.npy`
- band_energy: векторизация, mel-шкала, агрегаты и time-series (опционально)
- chroma: tuning, нормализация, downsample/save для больших матриц, агрегаты
- source_separation: избежание device mismatch за счёт CPU run при CUDA пайплайне

### Политика сериализации артефактов
- Если элементов матрицы > порога — сохраняем в `tmp_path` в формате `.npy`
- В payload указываем `*_npy` путь и `shape`, `elements`; inline-данные опциональны

### Метрики и мониторинг
- Фиксируем для каждого прогона: total CPU/GPU time, ускорение, экономия времени
- Пер-экстрактор тайминги (CPU/GPU) и доля от total
- Кол-во fallbacks и причин (модули недоступны/ошибка вызова)

### Чек-лист стабильности
- [ ] Нет необработанных исключений при отсутствующих зависимостях
- [ ] Все большие матрицы проходят через `.npy` путь при превышении порога
- [ ] Логи содержат device, главные параметры и ветку выполнения
- [ ] Manifest валиден и содержит только сериализуемые типы

### Выходные артефакты фазы
- Обновлённые экстракторы с fallbacks и стабильной сериализацией
- Обновлённый `PERFORMANCE_METRICS.md` с актуальными цифрами
- Тестовые отчёты CPU vs GPU по набору видео


